#!/usr/bin/env ruby

require 'rubygems'
require 'vagrant'

targets = ARGV.to_a 
exit 1 if targets.empty?

ENV['VAGRANT_LOG'] = "STDOUT"
Dir.chdir File.expand_path("../..", __FILE__)
env = Vagrant::Environment.new
env.cli "up"

begin
  env.primary_vm.ssh.execute do |ssh|
    ssh.exec!("DISPLAY=:1 PATH=/tmp/firefox/:$PATH cd /selenium-trunk && ./go #{targets.join ' '}") do |ch, type, data|
      case type
      when :stdout
        STDOUT.print data
      when :stderr
        STDERR.print data
      when :exit_status
        if data != 0
          puts "command failed with status: #{data}"
        end
      end
    end
  end
ensure
  # TODO: snapshots.
  puts "destroying VM..."
  env.cli "destroy"
end