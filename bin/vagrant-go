#!/usr/bin/env ruby

require 'rubygems'
require 'vagrant'
require 'fileutils'

targets = ARGV.to_a 
exit 1 if targets.empty?

selenium_ci_root = File.expand_path("../..", __FILE__)
selenium_trunk = "selenium-trunk"

repo = Dir.pwd # assume we're in the working dir
Dir.chdir selenium_ci_root
FileUtils.rm_rf selenium_trunk
File.symlink(repo, "selenium-trunk")

ENV['VAGRANT_LOG'] = "STDOUT"
env = Vagrant::Environment.new
env.cli "up"

begin
  env.primary_vm.ssh.execute do |ssh|
    ssh.exec!("DISPLAY=:1 PATH=/tmp/firefox/:$PATH cd /selenium-trunk && ./go #{targets.join ' '}") do |ch, type, data|
      case type
      when :stdout
        STDOUT.print data
      when :stderr
        STDERR.print data
      when :exit_status
        if data != 0
          puts "command failed with status: #{data}"
        end
      end
    end
  end
ensure
  # TODO: snapshots.
  puts "destroying VM..."
  env.cli "destroy"
end